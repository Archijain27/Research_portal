<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quick Notes</title>
  <style>
    :root{
      --accent:#4f46e5;
      --accent-2:#6d28d9;
      --bg:#f4f4ff;
      --card:#ffffff;
      --muted:#6b7280;
      --success:#10b981;
      --danger:#ef4444;
    }
   
    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: Arial, sans-serif;
      display: flex;
      height: 100vh;
      background: var(--bg);
    }
   
    .sidebar {
      width: 220px;
      background: linear-gradient(180deg, #4f46e5, #4338ca);
      color: white;
      padding: 20px 15px;
      display: flex;
      flex-direction: column;
      box-shadow: 3px 0 10px rgba(0,0,0,0.15);
    }

    .sidebar h2 {
      margin-top: 5px;
      font-size: 1.7rem;
      font-weight: bold;
      text-align: center;
      letter-spacing: 1px;
    }

    .sidebar ul {
      list-style: none;
      padding: 0;
      margin: 15px 0;
    }

    .sidebar li {
      margin: 12px 0;
      padding: 10px 15px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.2rem;
      display: flex;
      align-items: center;
      gap: 10px;
      transition: background 0.3s, transform 0.2s;
    }

    .sidebar li:hover {
      background: rgba(255,255,255,0.15);
      transform: translateX(5px);
    }

    .sidebar li.active {
      background: rgba(255,255,255,0.2);
    }

    .main {
      flex: 1;
      padding: 30px;
      background: var(--bg);
      overflow-y: auto;
    }

    .page-header {
      margin-bottom: 30px;
    }

    .page-header h1 {
      font-size: 2.5rem;
      color: #333;
      margin: 0 0 10px 0;
      font-weight: 700;
    }

    .page-header p {
      color: var(--muted);
      font-size: 1.1rem;
      margin: 0;
    }

    .back-btn {
      background: transparent;
      border: 1px solid var(--accent);
      color: var(--accent);
      padding: 8px 16px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 0.9rem;
      margin-bottom: 20px;
      transition: all 0.3s;
    }

    .back-btn:hover {
      background: var(--accent);
      color: white;
    }

    .notes-container {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 30px;
      max-width: 1400px;
    }

    .notes-section {
      background: var(--card);
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      border: 1px solid rgba(79,70,229,0.1);
    }

    .section-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 20px;
      padding-bottom: 15px;
      border-bottom: 1px solid #f0f0f7;
    }

    .section-icon {
      width: 40px;
      height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: white;
    }

    .voice-section .section-icon {
      background: linear-gradient(135deg, #f59e0b, #d97706);
    }

    .text-section .section-icon {
      background: linear-gradient(135deg, #6366f1, #4f46e5);
    }

    .section-title {
      font-size: 1.4rem;
      font-weight: 600;
      color: #333;
      margin: 0;
    }

    .voice-controls {
      display: flex;
      flex-direction: column;
      gap: 20px;
      margin-bottom: 20px;
    }

    .record-button {
      width: 100px;
      height: 100px;
      border-radius: 50%;
      border: none;
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      font-size: 2rem;
      cursor: pointer;
      margin: 0 auto;
      transition: all 0.3s;
      box-shadow: 0 4px 15px rgba(239, 68, 68, 0.3);
    }

    .record-button:hover {
      transform: scale(1.05);
      box-shadow: 0 6px 20px rgba(239, 68, 68, 0.4);
    }

    .record-button.recording {
      background: linear-gradient(135deg, #10b981, #059669);
      animation: pulse 2s infinite;
    }

    @keyframes pulse {
      0% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
      50% { box-shadow: 0 8px 25px rgba(16, 185, 129, 0.6); }
      100% { box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3); }
    }

    .recording-status {
      text-align: center;
      color: var(--muted);
      font-size: 1rem;
      margin-top: 10px;
    }

    .recording-time {
      font-weight: 600;
      color: var(--accent);
    }

    .text-input {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 20px;
    }

    .note-input {
      width: 100%;
      min-height: 200px;
      padding: 15px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      resize: vertical;
      outline: none;
      transition: border-color 0.3s;
    }

    .note-input:focus {
      border-color: var(--accent);
    }

    .note-title {
      width: 100%;
      padding: 12px 15px;
      border: 1px solid #e5e7eb;
      border-radius: 12px;
      font-size: 1rem;
      font-family: inherit;
      outline: none;
      transition: border-color 0.3s;
    }

    .note-title:focus {
      border-color: var(--accent);
    }

    .save-btn {
      background: linear-gradient(135deg, var(--accent), var(--accent-2));
      color: white;
      border: none;
      padding: 12px 24px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1rem;
      font-weight: 600;
      transition: opacity 0.3s;
    }

    .save-btn:hover {
      opacity: 0.9;
    }

    .save-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .notes-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      max-height: 600px;
      overflow-y: auto;
    }

    .note-item, .voice-item {
      background: rgba(79,70,229,0.05);
      border: 1px solid rgba(79,70,229,0.1);
      border-radius: 12px;
      padding: 15px;
      transition: all 0.3s;
    }

    .note-item:hover, .voice-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
    }

    .item-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 8px;
    }

    .item-title {
      font-weight: 600;
      color: #333;
      margin: 0;
      font-size: 1.1rem;
    }

    .item-date {
      color: var(--muted);
      font-size: 0.85rem;
    }

    .item-content {
      color: #4b5563;
      line-height: 1.5;
      margin-bottom: 10px;
    }

    .item-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    .btn-small {
      padding: 4px 8px;
      border: none;
      border-radius: 6px;
      font-size: 0.8rem;
      cursor: pointer;
      transition: opacity 0.3s;
    }

    .btn-small:hover {
      opacity: 0.8;
    }

    .btn-play {
      background: var(--success);
      color: white;
    }

    .btn-delete {
      background: var(--danger);
      color: white;
    }

    .empty-state {
      text-align: center;
      color: var(--muted);
      font-style: italic;
      padding: 40px 20px;
    }

    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: var(--success);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      transform: translateX(400px);
      transition: transform 0.3s;
      z-index: 1000;
    }

    .toast.show {
      transform: translateX(0);
    }

    .toast.error {
      background: var(--danger);
    }

    .loading {
      text-align: center;
      padding: 20px;
      color: var(--muted);
      font-style: italic;
    }

    .error {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: #dc2626;
      padding: 12px;
      border-radius: 8px;
      margin: 10px 0;
      text-align: center;
    }

    @media (max-width: 768px) {
      .notes-container {
        grid-template-columns: 1fr;
        gap: 20px;
      }
      
      .sidebar {
        width: 180px;
      }
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <h2>Menu</h2>
    <ul>
      <li id="menu-dashboard">Dashboard</li>
      <li id="menu-calendar">Calendar</li>
      <li>Research Paper</li>
      <li>Profile</li>
      <li id="logout">Logout</li>
    </ul>
  </div>

  <div class="main">
    <button class="back-btn" id="backBtn">‚Üê Back to Dashboard</button>
    
    <div class="page-header">
      <h1>Quick Notes</h1>
      <p>Capture your thoughts with voice recordings or text notes</p>
    </div>

    <div id="loadingMessage" class="loading" style="display: none;">
      Loading your notes...
    </div>

    <div id="errorMessage" class="error" style="display: none;">
      Failed to load notes. Please try again.
    </div>

    <div class="notes-container" id="notesContainer">
      <!-- Voice Recording Section -->
      <div class="notes-section voice-section">
        <div class="section-header">
          <div class="section-icon">üé§</div>
          <h3 class="section-title">Voice Recordings</h3>
        </div>

        <div class="voice-controls">
          <button class="record-button" id="recordBtn">üé§</button>
          <div class="recording-status">
            <div id="recordingStatus">Click to start recording</div>
            <div class="recording-time" id="recordingTime" style="display: none;">00:00</div>
          </div>
          <input type="text" class="note-title" id="voiceTitle" placeholder="Recording title (optional)" style="display: none;">
          <button class="save-btn" id="saveVoiceBtn" style="display: none;" disabled>Save Recording</button>
        </div>

        <div class="notes-list" id="voiceList">
          <div class="empty-state">No voice recordings yet</div>
        </div>
      </div>

      <!-- Text Notes Section -->
      <div class="notes-section text-section">
        <div class="section-header">
          <div class="section-icon">üìù</div>
          <h3 class="section-title">Text Notes</h3>
        </div>

        <div class="text-input">
          <input type="text" class="note-title" id="textTitle" placeholder="Note title">
          <textarea class="note-input" id="textContent" placeholder="Write your note here..."></textarea>
          <button class="save-btn" id="saveTextBtn">Save Note</button>
        </div>

        <div class="notes-list" id="textList">
          <div class="empty-state">No text notes yet</div>
        </div>
      </div>
    </div>
  </div>

  <div class="toast" id="toast"></div>

  <script>
    // API Configuration
    const API_BASE = window.location.origin;

    // Authentication check
    function getCurrentUser() {
      return sessionStorage.getItem('userEmail');
    }

    function isUserLoggedIn() {
      return sessionStorage.getItem('isLoggedIn') === 'true';
    }

    function redirectToLogin() {
      alert('Please log in to access this page');
      window.location.href = '/';
    }

    // Check authentication
    if (!isUserLoggedIn()) {
      redirectToLogin();
    }

    const userEmail = getCurrentUser();
    if (!userEmail) {
      redirectToLogin();
    }
    
    // Voice Recording Variables (Note: Voice recordings will still use localStorage for audio data)
    let mediaRecorder;
    let audioChunks = [];
    let isRecording = false;
    let recordingStartTime;
    let recordingTimer;
    let currentAudioBlob;

    // State
    let textNotes = [];

    // DOM Elements
    const recordBtn = document.getElementById('recordBtn');
    const recordingStatus = document.getElementById('recordingStatus');
    const recordingTime = document.getElementById('recordingTime');
    const voiceTitle = document.getElementById('voiceTitle');
    const saveVoiceBtn = document.getElementById('saveVoiceBtn');
    const voiceList = document.getElementById('voiceList');
    const textTitle = document.getElementById('textTitle');
    const textContent = document.getElementById('textContent');
    const saveTextBtn = document.getElementById('saveTextBtn');
    const textList = document.getElementById('textList');
    const toast = document.getElementById('toast');
    const backBtn = document.getElementById('backBtn');
    const loadingMessage = document.getElementById('loadingMessage');
    const errorMessage = document.getElementById('errorMessage');
    const notesContainer = document.getElementById('notesContainer');

    // API helper function
    async function apiCall(endpoint, options = {}) {
      try {
        const response = await fetch(`${API_BASE}${endpoint}`, {
          headers: {
            'Content-Type': 'application/json',
            ...options.headers
          },
          ...options
        });
        
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return await response.json();
      } catch (error) {
        console.error('API Error:', error);
        throw error;
      }
    }

    // Navigation
    backBtn.onclick = () => window.location.href = 'dashboard.html';
    document.getElementById('menu-dashboard').onclick = () => window.location.href = 'dashboard.html';
    document.getElementById('menu-calendar').onclick = () => window.location.href = 'dashboard.html';
    document.getElementById('logout').onclick = () => {
      sessionStorage.removeItem("userEmail");
      sessionStorage.removeItem("isLoggedIn");
      window.location.href = "/";
    };

    // Toast notification
    function showToast(message, isError = false) {
      toast.textContent = message;
      toast.className = 'toast' + (isError ? ' error' : '');
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), 3000);
    }

    // Load text notes from database
    async function loadTextNotes() {
      try {
        loadingMessage.style.display = 'block';
        errorMessage.style.display = 'none';
        notesContainer.style.display = 'none';

        const data = await apiCall(`/notes/${encodeURIComponent(userEmail)}`);
        textNotes = data;
        
        renderTextNotes();
        renderVoiceRecordings(); // Load voice recordings from localStorage
        
        loadingMessage.style.display = 'none';
        notesContainer.style.display = 'grid';
      } catch (error) {
        console.error("Failed to load notes:", error);
        loadingMessage.style.display = 'none';
        errorMessage.style.display = 'block';
        errorMessage.textContent = 'Failed to load notes. Please refresh the page.';
      }
    }

    // Voice Recording Functions
    async function initializeMediaRecorder() {
      try {
        const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
        mediaRecorder = new MediaRecorder(stream);

        mediaRecorder.ondataavailable = (event) => {
          audioChunks.push(event.data);
        };

        mediaRecorder.onstop = () => {
          currentAudioBlob = new Blob(audioChunks, { type: 'audio/wav' });
          audioChunks = [];
          voiceTitle.style.display = 'block';
          saveVoiceBtn.style.display = 'block';
          saveVoiceBtn.disabled = false;
        };

        return true;
      } catch (error) {
        showToast('Microphone access denied. Please enable microphone permissions.', true);
        return false;
      }
    }

    function startRecording() {
      if (!mediaRecorder) return;
      
      isRecording = true;
      recordBtn.classList.add('recording');
      recordBtn.innerHTML = '‚èπÔ∏è';
      recordingStatus.textContent = 'Recording...';
      recordingTime.style.display = 'block';
      
      recordingStartTime = Date.now();
      recordingTimer = setInterval(updateRecordingTime, 1000);
      
      mediaRecorder.start();
    }

    function stopRecording() {
      if (!mediaRecorder || !isRecording) return;
      
      isRecording = false;
      recordBtn.classList.remove('recording');
      recordBtn.innerHTML = 'üé§';
      recordingStatus.textContent = 'Recording stopped. Add a title and save.';
      recordingTime.style.display = 'none';
      
      clearInterval(recordingTimer);
      mediaRecorder.stop();
    }

    function updateRecordingTime() {
      const elapsed = Math.floor((Date.now() - recordingStartTime) / 1000);
      const minutes = Math.floor(elapsed / 60);
      const seconds = elapsed % 60;
      recordingTime.textContent = `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    recordBtn.onclick = async () => {
      if (!isRecording) {
        if (!mediaRecorder) {
          const initialized = await initializeMediaRecorder();
          if (!initialized) return;
        }
        startRecording();
      } else {
        stopRecording();
      }
    };

    // Save voice recording (still uses localStorage for audio data)
    saveVoiceBtn.onclick = () => {
      if (!currentAudioBlob) return;

      const title = voiceTitle.value.trim() || `Recording ${new Date().toLocaleString()}`;
      const recording = {
        id: Date.now(),
        title: title,
        date: new Date().toISOString(),
        audioData: currentAudioBlob
      };

      // Convert blob to base64 for storage
      const reader = new FileReader();
      reader.onload = () => {
        recording.audioData = reader.result;
        saveVoiceRecording(recording);
      };
      reader.readAsDataURL(currentAudioBlob);
    };

    function saveVoiceRecording(recording) {
      const recordings = getVoiceRecordings();
      recordings.unshift(recording);
      localStorage.setItem(`voice_recordings_${userEmail}`, JSON.stringify(recordings));
      
      // Reset form
      voiceTitle.value = '';
      voiceTitle.style.display = 'none';
      saveVoiceBtn.style.display = 'none';
      saveVoiceBtn.disabled = true;
      recordingStatus.textContent = 'Click to start recording';
      currentAudioBlob = null;
      
      renderVoiceRecordings();
      showToast('Voice recording saved successfully!');
    }

    // Text Notes Functions - Updated to use database
    saveTextBtn.onclick = async () => {
      const title = textTitle.value.trim();
      const content = textContent.value.trim();
      
      if (!title && !content) {
        showToast('Please enter a title or content for your note.', true);
        return;
      }

      try {
        saveTextBtn.textContent = 'Saving...';
        saveTextBtn.disabled = true;

        await apiCall("/notes", {
          method: "POST",
          body: JSON.stringify({
            user_email: userEmail,
            title: title || 'Untitled Note',
            content: content,
            created_date: new Date().toISOString()
          })
        });
        
        // Reset form
        textTitle.value = '';
        textContent.value = '';
        
        await loadTextNotes(); // Refresh the list
        showToast('Note saved successfully!');
        
      } catch (error) {
        console.error("Failed to save note:", error);
        showToast('Failed to save note. Please try again.', true);
      } finally {
        saveTextBtn.textContent = 'Save Note';
        saveTextBtn.disabled = false;
      }
    };

    // Data persistence functions
    function getVoiceRecordings() {
      const stored = localStorage.getItem(`voice_recordings_${userEmail}`);
      return stored ? JSON.parse(stored) : [];
    }

    // Render functions
    function renderVoiceRecordings() {
      const recordings = getVoiceRecordings();
      
      if (recordings.length === 0) {
        voiceList.innerHTML = '<div class="empty-state">No voice recordings yet</div>';
        return;
      }

      voiceList.innerHTML = recordings.map(recording => `
        <div class="voice-item">
          <div class="item-header">
            <h4 class="item-title">${recording.title}</h4>
            <span class="item-date">${new Date(recording.date).toLocaleDateString()}</span>
          </div>
          <div class="item-actions">
            <button class="btn-small btn-play" onclick="playRecording('${recording.id}')">‚ñ∂ Play</button>
            <button class="btn-small btn-delete" onclick="deleteVoiceRecording('${recording.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    function renderTextNotes() {
      if (textNotes.length === 0) {
        textList.innerHTML = '<div class="empty-state">No text notes yet</div>';
        return;
      }

      textList.innerHTML = textNotes.map(note => `
        <div class="note-item">
          <div class="item-header">
            <h4 class="item-title">${note.title}</h4>
            <span class="item-date">${new Date(note.created_date).toLocaleDateString()}</span>
          </div>
          <div class="item-content">${(note.content || '').substring(0, 200)}${(note.content || '').length > 200 ? '...' : ''}</div>
          <div class="item-actions">
            <button class="btn-small btn-delete" onclick="deleteTextNote('${note.id}')">Delete</button>
          </div>
        </div>
      `).join('');
    }

    // Global functions for button actions
    window.playRecording = (id) => {
      const recordings = getVoiceRecordings();
      const recording = recordings.find(r => r.id === parseInt(id));
      if (recording && recording.audioData) {
        const audio = new Audio(recording.audioData);
        audio.play().catch(e => showToast('Error playing recording', true));
      }
    };

    window.deleteVoiceRecording = (id) => {
      if (confirm('Are you sure you want to delete this recording?')) {
        const recordings = getVoiceRecordings().filter(r => r.id !== parseInt(id));
        localStorage.setItem(`voice_recordings_${userEmail}`, JSON.stringify(recordings));
        renderVoiceRecordings();
        showToast('Recording deleted');
      }
    };

    window.deleteTextNote = async (id) => {
      if (confirm('Are you sure you want to delete this note?')) {
        try {
          await apiCall(`/notes/${id}`, {
            method: "DELETE"
          });
          
          await loadTextNotes(); // Refresh the list
          showToast('Note deleted');
          
        } catch (error) {
          console.error("Failed to delete note:", error);
          showToast('Failed to delete note. Please try again.', true);
        }
      }
    };

    // Initialize the page
    loadTextNotes();
  </script>
</body>
</html>